{% extends "government/layout.html" %}
{% block content %}

<div class="page-header" style="margin-bottom: 30px;">
    <h2 style="font-size: 2rem; font-weight: 800;">Real-Time Analytics</h2>
    <p style="color: var(--secondary);">Data based on {{ complaints|length }} active reports.</p>
</div>

<div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px;">
    <div class="stat-card">
        <span class="stat-label">Total Reports</span>
        <div class="stat-value">{{ complaints|length }}</div>
    </div>
    <div class="stat-card">
        <span class="stat-label">Resolved</span>
        <div class="stat-value" id="resolvedCount">0</div>
    </div>
    <div class="stat-card">
        <span class="stat-label">Pending</span>
        <div class="stat-value" id="pendingCount">0</div>
    </div>
</div>

<div class="charts-container" style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px;">
    <div class="chart-wrapper">
        <h3>Complaints by Category</h3>
        <canvas id="issueTypeChart"></canvas>
    </div>
    <div class="chart-wrapper">
        <h3>Priority Distribution</h3>
        <canvas id="severityChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // 1. CONVERT JINJA DATA TO JAVASCRIPT
    // We create a simple array of objects from your database records
    const reports = [
        {% for c in complaints %}
        {
            issue: "{{ c.issue }}",
            severity: "{{ c.severity or 'Low' }}",
            status: "{{ c.status }}"
        },
        {% endfor %}
    ];

    // 2. LOGIC TO COUNT DATA
    const issueCounts = {};
    const severityCounts = { 'High': 0, 'Moderate': 0, 'Low': 0 };
    let resolved = 0;

    reports.forEach(r => {
        // Count Issues (Potholes, Garbage, etc.)
        issueCounts[r.issue] = (issueCounts[r.issue] || 0) + 1;
        
        // Count Severity
        if(severityCounts.hasOwnProperty(r.severity)) {
            severityCounts[r.severity]++;
        }
        
        // Count Status
        if(r.status === 'Resolved') resolved++;
    });

    // Update the Stats Cards
    document.getElementById('resolvedCount').innerText = resolved;
    document.getElementById('pendingCount').innerText = reports.length - resolved;

    // 3. RENDER BAR CHART (Issue Types)
    new Chart(document.getElementById('issueTypeChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(issueCounts),
            datasets: [{
                label: 'Reports',
                data: Object.values(issueCounts),
                backgroundColor: '#4f46e5',
                borderRadius: 8
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });

    // 4. RENDER DOUGHNUT CHART (Severity)
    new Chart(document.getElementById('severityChart'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(severityCounts),
            datasets: [{
                data: Object.values(severityCounts),
                backgroundColor: ['#ef4444', '#f59e0b', '#10b981'],
                borderWidth: 0
            }]
        },
        options: {
            cutout: '70%',
            plugins: { legend: { position: 'bottom' } }
        }
    });
</script>

{% endblock %}